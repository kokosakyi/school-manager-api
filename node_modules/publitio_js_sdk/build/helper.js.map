{"version":3,"sources":["../src/helper.js"],"names":["uint32Max","Math","pow","runningInNode","window","FormData","require","Helper","obj","str","property","Object","prototype","hasOwnProperty","call","push","encodeURIComponent","join","min","max","x","random","floor","number","Array","slice","Date","now","getTime","pad","mtRand","MIN","MAX","args","url","key","secret","version","appendArguments","serialize","method","fetchService","callApi","catch","error","api_nonce","apiNonce","api_timestamp","timestamp","api_key","api_signature","sign","api_kit","action","createUrl","dataOrStream","getDataFrom","then","data","formData","append","uploadFile","Promise","resolve","reject","Buffer","from","on","chunk","concat","err","helper"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;;;;;;;;;AAEA,IAAMA,SAAS,GAAGC,IAAI,CAACC,GAAL,CAAS,CAAT,EAAY,EAAZ,CAAlB;AAEO,IAAMC,aAAa,GAAI,OAAOC,MAAP,KAAkB,WAAzC;;AAEP,IAAMC,QAAQ,GAAIF,aAAD,GAAkBG,OAAO;AAAC;AAAmC,WAApC,CAAzB,GAA4EF,MAAM,CAACC,QAApG;;IAEqBE,M;;;;;;;;;8BACRC,G,EAAK;AACd,UAAMC,GAAG,GAAG,EAAZ;;AACA,WAAK,IAAMC,QAAX,IAAuBF,GAAvB,EAA4B;AAC1B,YAAIG,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCN,GAArC,EAA0CE,QAA1C,CAAJ,EAAyD;AACvDD,UAAAA,GAAG,CAACM,IAAJ,WAAYC,kBAAkB,CAACN,QAAD,CAA9B,cAA4CM,kBAAkB,CAACR,GAAG,CAACE,QAAD,CAAJ,CAA9D;AACD;AACF;;AACD,aAAOD,GAAG,CAACQ,IAAJ,CAAS,GAAT,CAAP;AACD;;;2BAEOC,G,EAAKC,G,EAAK;AAChB,UAAMC,CAAC,GAAGnB,IAAI,CAACoB,MAAL,EAAV;AACA,aAAOpB,IAAI,CAACqB,KAAL,CAAWF,CAAC,IAAID,GAAG,GAAGD,GAAN,GAAY,CAAhB,CAAZ,IAAkCA,GAAzC;AACD;;;wBAEIK,M,EAAQd,G,EAAK;AAChB,aAAO,CAACA,GAAG,GAAGe,KAAK,CAACD,MAAD,CAAL,CAAcN,IAAd,CAAmB,GAAnB,CAAP,EAAgCQ,KAAhC,CAAsC,CAAtC,EAAyCF,MAAzC,CAAP;AACD;;;gCAEY;AACX,UAAI,CAACG,IAAI,CAACC,GAAV,EAAe;AACbD,QAAAA,IAAI,CAACC,GAAL,GAAW,YAAM;AAAE,iBAAO1B,IAAI,CAACqB,KAAL,CAAW,IAAII,IAAJ,GAAWE,OAAX,KAAuB,IAAlC,CAAP;AAAgD,SAAnE;AACD;;AACD,aAAO3B,IAAI,CAACqB,KAAL,CAAWI,IAAI,CAACC,GAAL,KAAa,IAAxB,CAAP;AACD;;;+BAEW;AACV,aAAO,KAAKE,GAAL,CAAS,CAAT,EAAY,KAAKC,MAAL,CAAYC,cAAZ,EAAiBC,cAAjB,CAAZ,CAAP;AACD;;;8BAEUlB,I,EAA4C;AAAA,UAAtCmB,IAAsC,uEAA/B,EAA+B;AAAA,UAA3BC,GAA2B;AAAA,UAAtBC,GAAsB;AAAA,UAAjBC,MAAiB;AAAA,UAATC,OAAS;AACrDJ,MAAAA,IAAI,GAAG,KAAKK,eAAL,CAAqBL,IAArB,EAA2BE,GAA3B,EAAgCC,MAAhC,EAAwCC,OAAxC,CAAP;AACA,UAAIvB,IAAI,CAAC,CAAD,CAAJ,KAAY,GAAhB,EACEA,IAAI,GAAG,MAAMA,IAAb;AACF,uBAAUoB,GAAV,SAAgBpB,IAAhB,cAAwB,KAAKyB,SAAL,CAAeN,IAAf,CAAxB;AACD;;;4BAEQC,G,EAAKM,M,EAAQ;AACpB,aAAOC,oBAAaC,OAAb,CAAqBR,GAArB,EAA0BM,MAA1B,EACJG,KADI,CACE,UAACC,KAAD,EAAW;AAAE,cAAMA,KAAN;AAAa,OAD5B,CAAP;AAED;;;oCAEgBX,I,EAAME,G,EAAKC,M,EAAQC,O,EAAS;AAC3CJ,MAAAA,IAAI,CAACY,SAAL,GAAiB,KAAKC,QAAL,EAAjB;AACAb,MAAAA,IAAI,CAACc,aAAL,GAAqB,KAAKC,SAAL,EAArB;AACAf,MAAAA,IAAI,CAACgB,OAAL,GAAed,GAAf;AACAF,MAAAA,IAAI,CAACiB,aAAL,GAAqB,KAAKC,IAAL,CAAUlB,IAAV,EAAgBG,MAAhB,CAArB;AACAH,MAAAA,IAAI,CAACmB,OAAL,eAAoBf,OAApB;AAEA,aAAOJ,IAAP;AACD;;;yBAEKA,I,EAAMG,M,EAAQ;AAClB,aAAO,4BAAQH,IAAI,CAACc,aAAb,SAA6Bd,IAAI,CAACY,SAAlC,SAA8CT,MAA9C,EAAP;AACD;;;0CAEsBiB,M,EAAQpB,I,EAAMC,G,EAAKC,G,EAAKC,M,EAAQC,O,EAAS;AAC9D,UAAIgB,MAAM,KAAK,MAAf,EAAuB;AACrBnB,QAAAA,GAAG,GAAG,KAAKoB,SAAL,CAAe,eAAf,EAAgCrB,IAAhC,EAAsCC,GAAtC,EAA2CC,GAA3C,EAAgDC,MAAhD,EAAwDC,OAAxD,CAAN;AACD,OAFD,MAEO,IAAIgB,MAAM,KAAK,WAAf,EAA4B;AACjCnB,QAAAA,GAAG,GAAG,KAAKoB,SAAL,CAAe,oBAAf,EAAqCrB,IAArC,EAA2CC,GAA3C,EAAgDC,GAAhD,EAAqDC,MAArD,EAA6DC,OAA7D,CAAN;AACD;;AACD,aAAOH,GAAP;AACD,K,CAED;;;;+BACYqB,Y,EAAcrB,G,EAAK;AAC7B,aAAO,KAAKsB,WAAL,CAAiBD,YAAjB,EAA+BE,IAA/B,CAAoC,UAAAC,IAAI,EAAI;AACjD,YAAMC,QAAQ,GAAG,IAAItD,QAAJ,EAAjB;AACAsD,QAAAA,QAAQ,CAACC,MAAT,CAAgB,MAAhB,EAAwBF,IAAxB,EAA8B,MAA9B;AACA,eAAOjB,oBAAaoB,UAAb,CAAwBF,QAAxB,EAAkCzB,GAAlC,CAAP;AACD,OAJM,CAAP;AAKD;;;gCAEYqB,Y,EAAc;AACzB,aAAO,IAAIO,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,YAAI,CAAC7D,aAAD,IAAkBoD,YAAY,YAAYU,MAA1C,IAAoD,OAAOV,YAAP,KAAwB,QAAhF,EAA0F;AACxFQ,UAAAA,OAAO,CAACR,YAAD,CAAP;AACD,SAFD,MAEO;AACL,cAAIG,IAAI,GAAGO,MAAM,CAACC,IAAP,CAAY,EAAZ,CAAX;AACAX,UAAAA,YAAY,CAACY,EAAb,CAAgB,MAAhB,EAAwB,UAAAC,KAAK,EAAI;AAAEV,YAAAA,IAAI,GAAGO,MAAM,CAACI,MAAP,CAAc,CAACX,IAAD,EAAOU,KAAP,CAAd,CAAP;AAAqC,WAAxE;AACAb,UAAAA,YAAY,CAACY,EAAb,CAAgB,KAAhB,EAAuB;AAAA,mBAAMJ,OAAO,CAACE,MAAM,CAACC,IAAP,CAAYR,IAAZ,CAAD,CAAb;AAAA,WAAvB;AACAH,UAAAA,YAAY,CAACY,EAAb,CAAgB,OAAhB,EAAyB,UAAAG,GAAG;AAAA,mBAAIN,MAAM,CAACM,GAAD,CAAV;AAAA,WAA5B;AACD;AACF,OATM,CAAP;AAUD;;;;;;;AAGI,IAAMC,MAAM,GAAG,IAAIhE,MAAJ,EAAf","sourcesContent":["import SHA1 from 'crypto-js/sha1'\nimport { MIN, MAX } from './constants'\nimport { fetchService } from './fetch'\n\nconst uint32Max = Math.pow(2, 32)\n\nexport const runningInNode = (typeof window === 'undefined')\n\nconst FormData = (runningInNode) ? require(/* webpackExclude: /form-data$/ */ 'form-data') : window.FormData\n\nexport default class Helper {\n  serialize (obj) {\n    const str = []\n    for (const property in obj) {\n      if (Object.prototype.hasOwnProperty.call(obj, property)) {\n        str.push(`${encodeURIComponent(property)}=${encodeURIComponent(obj[property])}`)\n      }\n    }\n    return str.join('&')\n  }\n\n  mtRand (min, max) {\n    const x = Math.random()\n    return Math.floor(x * (max - min + 1)) + min\n  }\n\n  pad (number, str) {\n    return (str + Array(number).join('0')).slice(0, number)\n  }\n\n  timestamp () {\n    if (!Date.now) {\n      Date.now = () => { return Math.floor(new Date().getTime() / 1000) }\n    }\n    return Math.floor(Date.now() / 1000)\n  }\n\n  apiNonce () {\n    return this.pad(8, this.mtRand(MIN, MAX))\n  }\n\n  createUrl (call, args = [], url, key, secret, version) {\n    args = this.appendArguments(args, key, secret, version)\n    if (call[0] !== '/')\n      call = '/' + call\n    return `${url}${call}?${this.serialize(args)}`\n  }\n\n  callApi (url, method) {\n    return fetchService.callApi(url, method)\n      .catch((error) => { throw error })\n  }\n\n  appendArguments (args, key, secret, version) {\n    args.api_nonce = this.apiNonce()\n    args.api_timestamp = this.timestamp()\n    args.api_key = key\n    args.api_signature = this.sign(args, secret)\n    args.api_kit = `JS${version}`\n\n    return args\n  }\n\n  sign (args, secret) {\n    return SHA1(`${args.api_timestamp}${args.api_nonce}${secret}`)\n  }\n\n  getUrlForFileCreation (action, args, url, key, secret, version) {\n    if (action === 'file') {\n      url = this.createUrl('/files/create', args, url, key, secret, version)\n    } else if (action === 'watermark') {\n      url = this.createUrl('/watermarks/create', args, url, key, secret, version)\n    }\n    return url\n  }\n\n  // dataOrStream can be a Node Buffer, stream, or a string or Blob (or Blob subclasses such as File) in the browser.\n  uploadFile (dataOrStream, url) {\n    return this.getDataFrom(dataOrStream).then(data => {\n      const formData = new FormData()\n      formData.append('file', data, 'file')\n      return fetchService.uploadFile(formData, url)\n    })\n  }\n\n  getDataFrom (dataOrStream) {\n    return new Promise((resolve, reject) => {\n      if (!runningInNode || dataOrStream instanceof Buffer || typeof dataOrStream === 'string') {\n        resolve(dataOrStream)\n      } else {\n        let data = Buffer.from([])\n        dataOrStream.on('data', chunk => { data = Buffer.concat([data, chunk]) })\n        dataOrStream.on('end', () => resolve(Buffer.from(data)))\n        dataOrStream.on('error', err => reject(err))\n      }\n    })\n  }\n}\n\nexport const helper = new Helper()\n"],"file":"helper.js"}